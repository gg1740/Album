<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Corner</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- BCrypt.js for password hashing -->
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-content, .post-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .post-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .btn-primary:hover {
            transform: scale(1.02);
        }
        .btn-primary:active {
            transform: scale(0.98);
        }
        /* Spinner for loading states */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left-color: #fff;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">

    <!-- Main Application Container -->
    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Login Screen -->
        <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center">
            <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Welcome Back</h1>
                    <p class="text-gray-500">Please sign in to your account.</p>
                </div>
                <form id="login-form">
                    <div class="space-y-4">
                        <div>
                            <label for="username" class="text-sm font-medium text-gray-700 sr-only">Username</label>
                            <input type="text" id="username" placeholder="Username" required class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        </div>
                        <div>
                            <label for="password" class="text-sm font-medium text-gray-700 sr-only">Password</label>
                            <input type="password" id="password" placeholder="Password" required class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        </div>
                    </div>
                    <p id="login-error" class="text-red-500 text-sm mt-4 text-center hidden">Invalid username or password.</p>
                    <button type="submit" id="login-button" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 btn-primary mt-6 flex items-center justify-center">
                        <span id="login-button-text">Login</span>
                        <div id="login-spinner" class="spinner hidden ml-2"></div>
                    </button>
                </form>
                 <p class="text-center text-sm text-gray-500 mt-6">
                    Don't have an account? <a href="#" id="show-register-link" class="font-medium text-indigo-600 hover:text-indigo-500">Register here</a>
                </p>
            </div>
        </div>
        
        <!-- Registration Screen -->
        <div id="register-screen" class="min-h-screen flex flex-col items-center justify-center hidden">
            <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Create Account</h1>
                    <p class="text-gray-500">Get started with your own profile.</p>
                </div>
                <form id="register-form">
                    <div class="space-y-4">
                        <div>
                            <label for="register-username" class="text-sm font-medium text-gray-700 sr-only">Username</label>
                            <input type="text" id="register-username" placeholder="Username (min. 3 characters)" required class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        </div>
                        <div>
                            <label for="register-password" class="text-sm font-medium text-gray-700 sr-only">Password</label>
                            <input type="password" id="register-password" placeholder="Password (min. 6 characters)" required class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        </div>
                         <div>
                            <label for="register-confirm-password" class="text-sm font-medium text-gray-700 sr-only">Confirm Password</label>
                            <input type="password" id="register-confirm-password" placeholder="Confirm Password" required class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        </div>
                    </div>
                    <p id="register-error" class="text-red-500 text-sm mt-4 text-center hidden"></p>
                    <p id="register-success" class="text-green-500 text-sm mt-4 text-center hidden"></p>
                    <button type="submit" id="register-button" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 btn-primary mt-6 flex items-center justify-center">
                        <span id="register-button-text">Register</span>
                        <div id="register-spinner" class="spinner hidden ml-2"></div>
                    </button>
                </form>
                 <p class="text-center text-sm text-gray-500 mt-6">
                    Already have an account? <a href="#" id="show-login-link" class="font-medium text-indigo-600 hover:text-indigo-500">Login here</a>
                </p>
            </div>
        </div>

        <!-- Main App Content -->
        <div id="main-content" class="hidden">
            <div id="profile-banner" class="h-48 bg-cover bg-center rounded-2xl mb-8 shadow-inner" style="background-image: url('https://placehold.co/1200x300/E0E7FF/4F46E5?text=Welcome');"></div>
            <header class="flex items-center justify-between mb-8 pb-4 border-b border-gray-200">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Activity Feed</h1>
                    <p id="welcome-message" class="text-gray-500 mt-1">Viewing all posts</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="profile-btn" class="font-medium text-gray-600 hover:text-indigo-600 transition-colors">Profile</button>
                    <button id="settings-btn" class="font-medium text-gray-600 hover:text-indigo-600 transition-colors">Settings</button>
                    <button id="logout-btn" class="font-medium text-indigo-600 hover:text-indigo-800 transition-colors">Logout</button>
                </div>
            </header>

            <!-- Create Post Form -->
            <div class="bg-white p-6 rounded-2xl shadow-md mb-8">
                <h2 class="text-xl font-bold mb-4">Create a New Post</h2>
                <form id="post-form">
                    <textarea id="post-content" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" rows="4" placeholder="What's on your mind?"></textarea>
                    <div id="media-preview-container" class="mt-4 hidden"></div>
                    <div class="flex justify-between items-center mt-4">
                        <label for="media-upload" class="cursor-pointer text-indigo-600 hover:text-indigo-800 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block -mt-1 mr-1"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                            Attach Photo/Video
                        </label>
                        <input type="file" id="media-upload" class="hidden" accept="image/*,video/*">
                        <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-indigo-700 btn-primary disabled:bg-gray-400" id="post-submit-btn">Post</button>
                    </div>
                </form>
            </div>

            <!-- Posts Feed -->
            <div>
                 <h2 class="text-xl font-bold mb-4">Recent Activity</h2>
                <div id="posts-feed" class="space-y-6">
                    <div id="loading-state" class="text-center text-gray-500 py-10">Loading posts...</div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="profile-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md modal-content max-h-full overflow-y-auto">
                <h2 class="text-2xl font-bold mb-6">Edit Profile</h2>
                <form id="profile-form">
                    <div class="space-y-4">
                        <div>
                            <label for="display-name" class="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
                            <input type="text" id="display-name" class="w-full border border-gray-300 rounded-lg p-3" required>
                        </div>
                         <div>
                            <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Title / Headline</label>
                            <input type="text" id="title" class="w-full border border-gray-300 rounded-lg p-3" placeholder="e.g., Creative Explorer">
                        </div>
                        <div>
                            <label for="bio" class="block text-sm font-medium text-gray-700 mb-1">Bio</label>
                            <textarea id="bio" class="w-full border border-gray-300 rounded-lg p-3" rows="3" placeholder="Tell us a little about yourself..."></textarea>
                        </div>
                        <div>
                            <label for="profile-pic-upload" class="block text-sm font-medium text-gray-700 mb-1">Profile Picture</label>
                            <div class="flex items-center space-x-4">
                                <img id="profile-pic-preview" class="w-24 h-24 rounded-full object-cover" src="https://placehold.co/96x96/E0E7FF/4F46E5?text=You" alt="Profile preview">
                                <input type="file" id="profile-pic-upload" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100" accept="image/*">
                            </div>
                        </div>
                        <div>
                             <label for="background-pic-upload" class="block text-sm font-medium text-gray-700 mb-1">Background Picture</label>
                             <img id="background-pic-preview" class="w-full h-32 object-cover rounded-lg mb-2" src="https://placehold.co/400x150/E0E7FF/4F46E5?text=Banner" alt="Background preview">
                             <input type="file" id="background-pic-upload" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100" accept="image/*">
                        </div>
                    </div>
                    <div id="profile-loading-spinner" class="mt-6 hidden justify-center"><div class="spinner"></div></div>
                    <div class="flex justify-end space-x-4 mt-8">
                        <button type="button" id="cancel-profile-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg">Cancel</button>
                        <button type="submit" id="save-profile-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md modal-content max-h-full overflow-y-auto">
                <h2 class="text-2xl font-bold mb-6">Account Settings</h2>
                <div class="mb-8">
                    <h3 class="text-lg font-semibold border-b pb-2 mb-4">Change Username</h3>
                    <p class="text-sm text-gray-600 mb-4">Changing your username is disabled to prevent data loss. Your username acts as your permanent ID.</p>
                    <input type="text" id="current-username" class="w-full border bg-gray-100 border-gray-300 rounded-lg p-3" disabled>
                </div>
                <div>
                    <h3 class="text-lg font-semibold border-b pb-2 mb-4">Change Password</h3>
                     <p class="text-sm text-gray-600 mb-4">Your password is now stored securely. Changes are permanent.</p>
                    <form id="password-form">
                        <div class="space-y-4">
                            <div>
                                <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                                <input type="password" id="current-password" class="w-full border border-gray-300 rounded-lg p-3" required>
                            </div>
                            <div>
                                <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                                <input type="password" id="new-password" class="w-full border border-gray-300 rounded-lg p-3" required>
                            </div>
                            <div>
                                <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                                <input type="password" id="confirm-password" class="w-full border border-gray-300 rounded-lg p-3" required>
                            </div>
                        </div>
                        <p id="password-feedback" class="text-sm mt-4 text-center"></p>
                        <div class="flex justify-end space-x-4 mt-6">
                            <button type="button" id="cancel-settings-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg">Cancel</button>
                            <button type="submit" id="save-password-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg btn-primary">Save Password</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="view-profile-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white p-0 rounded-2xl shadow-lg w-full max-w-md modal-content max-h-full overflow-y-auto relative">
                <button id="close-view-profile-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
                <div id="view-profile-banner" class="h-40 bg-cover bg-center rounded-t-2xl" style="background-image: url('https://placehold.co/400x160/E0E7FF/4F46E5');"></div>
                <div class="p-8">
                    <div class="flex flex-col items-center -mt-20">
                        <img id="view-profile-pic" class="w-28 h-28 rounded-full object-cover border-4 border-white shadow-lg" src="https://placehold.co/112x112/E0E7FF/4F46E5?text=User" alt="Profile picture">
                        <h2 id="view-profile-name" class="text-3xl font-bold mt-4">Display Name</h2>
                        <p id="view-profile-title" class="text-gray-500 mt-1">User Title</p>
                    </div>
                    <div class="mt-8 text-center">
                        <h3 class="text-lg font-semibold border-b pb-2 mb-4">Bio</h3>
                        <p id="view-profile-bio" class="text-gray-700">User bio goes here.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="delete-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm">
                <h2 class="text-xl font-bold mb-4">Confirm Deletion</h2>
                <p class="text-gray-600 mb-6">Are you sure you want to delete this post? This action cannot be undone.</p>
                <div class="flex justify-end space-x-4">
                    <button id="cancel-delete-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg">Cancel</button>
                    <button id="confirm-delete-btn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg btn-primary">Delete</button>
                </div>
            </div>
        </div>
        
        <div id="edit-post-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md">
                <h2 class="text-xl font-bold mb-4">Edit Post</h2>
                <form id="edit-post-form">
                    <textarea id="edit-post-content" class="w-full border border-gray-300 rounded-lg p-3" rows="6"></textarea>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-edit-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg">Cancel</button>
                        <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const bcrypt = dcodeIO.bcrypt;
            const supabaseUrl = 'https://gmspsldgxgbhtoepkyaw.supabase.co';
            const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdtc3BzbGRneGdiaHRvZXBreWF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMjA0NjIsImV4cCI6MjA3NDY5NjQ2Mn0.7wMhuvMrMhxAbo4lSKCnF5wa5_XtOGKAtu3hOqmxDBg';
            let supabaseClient;
            try {
                supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
            } catch (error) {
                 console.error("Supabase initialization failed.", error);
                 alert("Could not initialize Supabase.");
            }
            
            let currentUser = null;
            let postsSubscription = null;
            let postToDelete = {};
            let postToEditId = null;

            const loginScreen = document.getElementById('login-screen');
            const registerScreen = document.getElementById('register-screen');
            const mainContent = document.getElementById('main-content');
            const loginForm = document.getElementById('login-form');
            const loginButton = document.getElementById('login-button');
            const loginButtonText = document.getElementById('login-button-text');
            const loginSpinner = document.getElementById('login-spinner');
            const registerForm = document.getElementById('register-form');
            const registerButton = document.getElementById('register-button');
            const registerButtonText = document.getElementById('register-button-text');
            const registerSpinner = document.getElementById('register-spinner');
            const showRegisterLink = document.getElementById('show-register-link');
            const showLoginLink = document.getElementById('show-login-link');
            const welcomeMessage = document.getElementById('welcome-message');
            const postsFeed = document.getElementById('posts-feed');
            const postForm = document.getElementById('post-form');
            const postContent = document.getElementById('post-content');
            const mediaUpload = document.getElementById('media-upload');
            const mediaPreviewContainer = document.getElementById('media-preview-container');
            const postSubmitBtn = document.getElementById('post-submit-btn');
            const profileModal = document.getElementById('profile-modal');
            const profileForm = document.getElementById('profile-form');
            const displayNameInput = document.getElementById('display-name');
            const titleInput = document.getElementById('title');
            const bioInput = document.getElementById('bio');
            const profilePicUpload = document.getElementById('profile-pic-upload');
            const profilePicPreview = document.getElementById('profile-pic-preview');
            const backgroundPicUpload = document.getElementById('background-pic-upload');
            const backgroundPicPreview = document.getElementById('background-pic-preview');
            const profileBanner = document.getElementById('profile-banner');
            const profileLoadingSpinner = document.getElementById('profile-loading-spinner');
            const saveProfileBtn = document.getElementById('save-profile-btn');
            const settingsModal = document.getElementById('settings-modal');
            const passwordForm = document.getElementById('password-form');
            const passwordFeedback = document.getElementById('password-feedback');
            const viewProfileModal = document.getElementById('view-profile-modal');
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const editPostModal = document.getElementById('edit-post-modal');
            const editPostForm = document.getElementById('edit-post-form');
            const editPostContent = document.getElementById('edit-post-content');

            function showLogin() {
                registerScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
            }
            function showRegister() {
                loginScreen.classList.add('hidden');
                registerScreen.classList.remove('hidden');
            }

            async function handleRegister(e) {
                e.preventDefault();
                const registerError = document.getElementById('register-error');
                const registerSuccess = document.getElementById('register-success');
                registerError.classList.add('hidden');
                registerSuccess.classList.add('hidden');

                const username = document.getElementById('register-username').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;

                if (username.length < 3) {
                    registerError.textContent = "Username must be at least 3 characters.";
                    registerError.classList.remove('hidden'); return;
                }
                if (password.length < 6) {
                    registerError.textContent = "Password must be at least 6 characters.";
                    registerError.classList.remove('hidden'); return;
                }
                if (password !== confirmPassword) {
                    registerError.textContent = "Passwords do not match.";
                    registerError.classList.remove('hidden'); return;
                }

                registerButton.disabled = true;
                registerButtonText.classList.add('hidden');
                registerSpinner.classList.remove('hidden');

                try {
                    const { data: existingUser, error: checkError } = await supabaseClient.from('profiles').select('username').eq('username', username).single();
                    if (checkError && checkError.code !== 'PGRST116') throw checkError;
                    if (existingUser) throw new Error("Username is already taken.");

                    const salt = await bcrypt.genSalt(10);
                    const hash = await bcrypt.hash(password, salt);
                    
                    const { error: createError } = await supabaseClient.from('profiles').insert({
                        username: username, password_hash: hash, display_name: username,
                        profile_picture_url: `https://placehold.co/96x96/E0E7FF/4F46E5?text=${username.slice(0,1).toUpperCase()}`,
                        title: 'New User', bio: '',
                        background_picture_url: 'https://placehold.co/1200x300/E0E7FF/4F46E5?text=Welcome'
                    });
                    if(createError) throw createError;

                    registerSuccess.textContent = "Registration successful! Please log in.";
                    registerSuccess.classList.remove('hidden');
                    registerForm.reset();
                    setTimeout(showLogin, 2000);
                } catch (error) {
                    console.error("Registration failed:", error);
                    registerError.textContent = error.message;
                    registerError.classList.remove('hidden');
                } finally {
                    registerButton.disabled = false;
                    registerButtonText.classList.remove('hidden');
                    registerSpinner.classList.add('hidden');
                }
            }

            async function handleLogin(e) {
                e.preventDefault();
                const loginError = document.getElementById('login-error');
                loginError.classList.add('hidden');
                loginButton.disabled = true;
                loginButtonText.classList.add('hidden');
                loginSpinner.classList.remove('hidden');

                try {
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    
                    const { data: profile, error } = await supabaseClient.from('profiles').select('password_hash').eq('username', username).single();
                    if (error) throw new Error("Could not find that username.");
                    
                    const match = await bcrypt.compare(password, profile.password_hash);
                    if (match) {
                        await loadUserProfile(username);
                        loginScreen.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        listenForPosts();
                    } else {
                        loginError.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Login failed:", error);
                    loginError.textContent = error.message;
                    loginError.classList.remove('hidden');
                } finally {
                    loginButton.disabled = false;
                    loginButtonText.classList.remove('hidden');
                    loginSpinner.classList.add('hidden');
                }
            }
            
            async function loadUserProfile(username) {
                const { data, error } = await supabaseClient.from('profiles').select('*').eq('username', username).single();
                if (error) throw new Error("Failed to load user profile after login.");
                currentUser = data;
                updateUIForUser();
            }

            function logout() {
                currentUser = null;
                if(postsSubscription) postsSubscription.unsubscribe();
                mainContent.classList.add('hidden');
                showLogin();
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                postsFeed.innerHTML = '<div id="loading-state" class="text-center text-gray-500 py-10">Loading posts...</div>';
            }
            
            function updateUIForUser() {
                 if (!currentUser) return;
                 welcomeMessage.textContent = `Logged in as ${currentUser.display_name}.`;
                 profileBanner.style.backgroundImage = `url('${currentUser.background_picture_url}')`;
            }

            function openProfileEditor() {
                displayNameInput.value = currentUser.display_name;
                titleInput.value = currentUser.title;
                bioInput.value = currentUser.bio;
                profilePicPreview.src = currentUser.profile_picture_url;
                backgroundPicPreview.src = currentUser.background_picture_url;
                profileModal.classList.remove('hidden');
            }

            function closeProfileEditor() {
                profileModal.classList.add('hidden');
                profileForm.reset();
            }

            async function saveProfile(e) {
                e.preventDefault();
                saveProfileBtn.disabled = true;
                profileLoadingSpinner.style.display = 'flex';

                let profilePicUrl = currentUser.profile_picture_url;
                const profileFile = profilePicUpload.files[0];
                if (profileFile) profilePicUrl = await uploadFile(profileFile, 'profile-pictures');

                let backgroundPicUrl = currentUser.background_picture_url;
                const backgroundFile = backgroundPicUpload.files[0];
                if (backgroundFile) backgroundPicUrl = await uploadFile(backgroundFile, 'profile-pictures');

                const updates = {
                    display_name: displayNameInput.value, title: titleInput.value, bio: bioInput.value,
                    profile_picture_url: profilePicUrl, background_picture_url: backgroundPicUrl
                };

                const { data, error } = await supabaseClient.from('profiles').update(updates).eq('username', currentUser.username).select().single();
                if (error) {
                    console.error("Error saving profile:", error);
                } else {
                    currentUser = data;
                    updateUIForUser();
                    closeProfileEditor();
                }
                saveProfileBtn.disabled = false;
                profileLoadingSpinner.style.display = 'none';
            }

            function openSettingsEditor() {
                document.getElementById('current-username').value = currentUser.username;
                passwordFeedback.textContent = '';
                passwordForm.reset();
                settingsModal.classList.remove('hidden');
            }

            function closeSettingsEditor() {
                settingsModal.classList.add('hidden');
            }

            async function handleChangePassword(e) {
                e.preventDefault();
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                const match = await bcrypt.compare(currentPassword, currentUser.password_hash);
                if (!match) {
                    passwordFeedback.textContent = 'Current password is incorrect.';
                    passwordFeedback.className = 'text-sm mt-4 text-center text-red-500'; return;
                }
                if (newPassword.length < 6) {
                    passwordFeedback.textContent = "New password must be at least 6 characters.";
                    passwordFeedback.className = 'text-sm mt-4 text-center text-red-500'; return;
                }
                if (newPassword !== confirmPassword) {
                    passwordFeedback.textContent = 'New passwords do not match.';
                    passwordFeedback.className = 'text-sm mt-4 text-center text-red-500'; return;
                }

                const salt = await bcrypt.genSalt(10);
                const newHash = await bcrypt.hash(newPassword, salt);
                const { data, error } = await supabaseClient.from('profiles').update({ password_hash: newHash }).eq('username', currentUser.username).select().single();
                    
                if(error) {
                    console.error("Error updating password:", error);
                    passwordFeedback.textContent = 'Could not update password. Please try again.';
                    passwordFeedback.className = 'text-sm mt-4 text-center text-red-500';
                } else {
                    currentUser = data;
                    passwordFeedback.textContent = 'Password updated successfully!';
                    passwordFeedback.className = 'text-sm mt-4 text-center text-green-500';
                    setTimeout(closeSettingsEditor, 2000);
                }
            }
            
            async function openViewProfileModal(username) {
                if (!username) return;
                const { data, error } = await supabaseClient.from('profiles').select('*').eq('username', username).single();
                if (error) { console.error('Error fetching profile to view:', error); return; }
                if (data) {
                    document.getElementById('view-profile-banner').style.backgroundImage = `url('${data.background_picture_url}')`;
                    document.getElementById('view-profile-pic').src = data.profile_picture_url;
                    document.getElementById('view-profile-name').textContent = data.display_name;
                    document.getElementById('view-profile-title').textContent = data.title || 'No title set';
                    document.getElementById('view-profile-bio').textContent = data.bio || 'No bio set.';
                    viewProfileModal.classList.remove('hidden');
                }
            }

            function closeViewProfileModal() {
                viewProfileModal.classList.add('hidden');
            }

            async function fetchAndRenderPosts() {
                const { data: posts, error } = await supabaseClient.from('posts').select(`*, profiles ( display_name, profile_picture_url )`).order('created_at', { ascending: false });
                if (error) { console.error('Error fetching posts:', error); return; }
                renderPosts(posts);
            }
            
            function renderPosts(posts) {
                const loadingState = document.getElementById('loading-state');
                if (!posts || !posts.length) {
                    postsFeed.innerHTML = `<p class="text-center text-gray-500 py-10">No posts yet.</p>`;
                    return;
                }
                loadingState.style.display = 'none';
                postsFeed.innerHTML = '';

                posts.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.className = 'bg-white p-5 rounded-xl shadow-md post-card';
                    const postDate = new Date(post.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                    let mediaHTML = '';
                    if (post.media_url) {
                        if (post.media_type.startsWith('image/')) {
                            mediaHTML = `<img src="${post.media_url}" alt="User upload" class="mt-4 rounded-lg w-full h-auto max-h-96 object-contain">`;
                        } else if (post.media_type.startsWith('video/')) {
                            mediaHTML = `<video controls src="${post.media_url}" class="mt-4 rounded-lg w-full max-h-96"></video>`;
                        }
                    }

                    let editDeleteControls = '';
                    if (currentUser && post.user_id === currentUser.username) {
                        editDeleteControls = `
                            <button class="edit-post-btn text-gray-400 hover:text-indigo-500 ml-2" data-post-id="${post.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                            <button class="delete-post-btn text-gray-400 hover:text-red-500 ml-2" data-post-id="${post.id}" data-media-url="${post.media_url || ''}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        `;
                    }

                    postElement.innerHTML = `
                        <div class="flex items-start space-x-4">
                             <img src="${post.profiles.profile_picture_url}" data-username="${post.user_id}" class="w-12 h-12 rounded-full object-cover cursor-pointer view-profile-trigger" alt="${post.profiles.display_name}'s profile picture">
                             <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <span class="font-bold text-lg cursor-pointer view-profile-trigger" data-username="${post.user_id}">${post.profiles.display_name}</span>
                                    <div class="flex items-center">
                                        <span class="text-xs text-gray-400">${postDate}</span>
                                        ${editDeleteControls}
                                    </div>
                                </div>
                                <p class="text-gray-700 whitespace-pre-wrap mt-1">${post.content}</p>
                             </div>
                        </div>
                        ${mediaHTML}
                    `;
                    postsFeed.appendChild(postElement);
                });
            }
            
            function listenForPosts() {
                if (postsSubscription) postsSubscription.unsubscribe();
                fetchAndRenderPosts();
                postsSubscription = supabaseClient.channel('public:posts').on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, fetchAndRenderPosts).subscribe();
            }
            
            async function createPost(e) {
                e.preventDefault();
                const content = postContent.value.trim();
                const file = mediaUpload.files[0];
                if (!currentUser || (!content && !file)) return;
                
                postSubmitBtn.disabled = true; postSubmitBtn.textContent = 'Posting...';
                let mediaUrl = null, mediaType = null;
                if (file) {
                    mediaUrl = await uploadFile(file, 'post-media');
                    mediaType = file.type;
                }
                const { error } = await supabaseClient.from('posts').insert({ user_id: currentUser.username, content, media_url: mediaUrl, media_type: mediaType });
                if (error) console.error("Error creating post:", error);
                else {
                    postForm.reset();
                    mediaPreviewContainer.innerHTML = '';
                    mediaPreviewContainer.classList.add('hidden');
                }
                postSubmitBtn.disabled = false; postSubmitBtn.textContent = 'Post';
            }
            
            function openDeleteConfirmation(postId, mediaUrl) {
                postToDelete = { postId, mediaUrl };
                deleteConfirmModal.classList.remove('hidden');
            }

            async function handleDeletePost() {
                const { postId, mediaUrl } = postToDelete;
                if (!postId) return;

                if (mediaUrl) {
                    const filePath = mediaUrl.substring(mediaUrl.lastIndexOf('post-media/') + 'post-media/'.length);
                    const { error: storageError } = await supabaseClient.storage.from('post-media').remove([filePath]);
                    if (storageError) console.error("Error deleting file:", storageError);
                }
                
                const { error: dbError } = await supabaseClient.from('posts').delete().eq('id', postId);
                if (dbError) console.error("Error deleting post:", dbError);
                
                deleteConfirmModal.classList.add('hidden');
                postToDelete = {};
            }
            
             async function openEditPostModal(postId) {
                try {
                    const { data: post, error } = await supabaseClient.from('posts').select('content').eq('id', postId).single();
                    if (error) throw error;
                    postToEditId = postId;
                    editPostContent.value = post.content;
                    editPostModal.classList.remove('hidden');
                } catch (error) {
                    console.error("Error fetching post to edit:", error);
                    alert("Could not load post for editing.");
                }
            }

            function closeEditPostModal() {
                editPostModal.classList.add('hidden');
                postToEditId = null;
            }

            async function handleEditPost(e) {
                e.preventDefault();
                if (!postToEditId) return;

                const newContent = editPostContent.value;
                const { error } = await supabaseClient.from('posts').update({ content: newContent }).eq('id', postToEditId);
                if (error) {
                    console.error("Error updating post:", error);
                    alert("Failed to save changes.");
                } else {
                    closeEditPostModal();
                }
            }
            
            async function uploadFile(file, bucket) {
                const fileName = `${currentUser.username}/${Date.now()}_${file.name}`;
                const { error } = await supabaseClient.storage.from(bucket).upload(fileName, file);
                if (error) { console.error(`Error uploading to ${bucket}:`, error); return null; }
                const { data } = supabaseClient.storage.from(bucket).getPublicUrl(fileName);
                return data.publicUrl;
            }

            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showRegister(); });
            showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showLogin(); });

            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('profile-btn').addEventListener('click', openProfileEditor);
            document.getElementById('cancel-profile-btn').addEventListener('click', closeProfileEditor);
            profileForm.addEventListener('submit', saveProfile);
            postForm.addEventListener('submit', createPost);
            document.getElementById('settings-btn').addEventListener('click', openSettingsEditor);
            document.getElementById('cancel-settings-btn').addEventListener('click', closeSettingsEditor);
            passwordForm.addEventListener('submit', handleChangePassword);
            document.getElementById('close-view-profile-btn').addEventListener('click', closeViewProfileModal);
            document.getElementById('cancel-delete-btn').addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));
            confirmDeleteBtn.addEventListener('click', handleDeletePost);
            editPostForm.addEventListener('submit', handleEditPost);
            document.getElementById('cancel-edit-btn').addEventListener('click', closeEditPostModal);

            postsFeed.addEventListener('click', (e) => {
                if (e.target.closest('.view-profile-trigger')) {
                    const username = e.target.closest('.view-profile-trigger').dataset.username;
                    openViewProfileModal(username);
                }
                if (e.target.closest('.delete-post-btn')) {
                    const button = e.target.closest('.delete-post-btn');
                    openDeleteConfirmation(button.dataset.postId, button.dataset.mediaUrl);
                }
                 if (e.target.closest('.edit-post-btn')) {
                    const button = e.target.closest('.edit-post-btn');
                    openEditPostModal(button.dataset.postId);
                }
            });

            mediaUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    mediaPreviewContainer.classList.remove('hidden');
                    mediaPreviewContainer.innerHTML = '';
                    let previewElement = file.type.startsWith('image/') ? document.createElement('img') : document.createElement('p');
                    if (file.type.startsWith('image/')) {
                        previewElement.src = URL.createObjectURL(file);
                        previewElement.className = 'max-h-40 rounded-lg';
                    } else {
                        previewElement.textContent = `Selected video: ${file.name}`;
                        previewElement.className = 'text-sm text-gray-600';
                    }
                    mediaPreviewContainer.appendChild(previewElement);
                }
            });

            profilePicUpload.addEventListener('change', (e) => {
                 const file = e.target.files[0]; if (file) profilePicPreview.src = URL.createObjectURL(file);
            });
            
            backgroundPicUpload.addEventListener('change', (e) => {
                 const file = e.target.files[0]; if (file) backgroundPicPreview.src = URL.createObjectURL(file);
            });
        });
    </script>
</body>
</html>

